# AGENTS.md

## 1. Agent 的角色与总体原则

总体原则：

* 可以根据需要调整代码结构、抽象与组织方式
* 不得引入功能回退或业务语义变化
* 不得破坏既有架构约束、测试假设与数据模拟契约
* 所有重要修改必须可解释、可验证、可追踪

---

## 2. 规范遵循

Agent 在任何情况下都必须遵循以下规范文档：

```text
docs/regulations/Architecture.md（架构规范）
docs/regulations/Testing.md（测试规范）
docs/regulations/DataSimulation.md（数据模拟规范）
```

具体要求包括但不限于：

* 严格保持单向依赖关系

```text
views → providers → services → models
```

* providers 作为唯一业务真相来源
* views 不包含业务逻辑或副作用
* Fake service 与真实 service 保持接口一致
* 所有时间、随机性与异步行为可控、可测试

---

## 3. 重构策略

### 3.1 重构总体授权

Agent **被允许**在以下场景下进行重构：

* 改善代码结构、可读性或可维护性
* 消除技术债务
* 统一或简化抽象
* 为后续功能或真实硬件接入做准备
* 对齐规范文档中的最佳实践

---

### 3.2 重构的硬性前提

无论重构规模大小，必须同时满足：

1. **功能不变**

   * 对用户可见行为不变
   * 业务语义不变
   * 状态机转移语义不变
   * 指标计算结果在同等输入下保持一致

2. **测试可验证**

   * 所有既有测试必须通过
   * 若测试无法覆盖变更点，必须补充测试
   * 不允许通过删除或弱化测试来“适配”重构

3. **架构仍然成立**

   * 分层结构清晰
   * 依赖方向不被破坏
   * provider 仍为业务中心

---

### 3.3 不允许的行为

Agent 不得：

* 改变业务含义却未在日志中明确说明
* 引入无法测试的逻辑
* 使用真实时间、真实随机性作为逻辑前提
* 让 Fake 行为与真实实现语义分叉
* 通过“更优雅”为理由引入隐式或难以理解的逻辑

---

## 4. 测试要求

Agent 必须遵循测试规范中的全部要求，重点包括：

* 新增 provider 必须有测试
* 状态机、指标逻辑变更必须更新测试
* 使用 `ProviderContainer` 测试 providers
* 时间推进使用 fake_async 或 clock abstraction
* 禁止依赖真实时间流逝

测试的目标是**锁死行为语义，而不是追求覆盖率**。

---

## 5. 数据模拟要求

Fake / 模拟数据是项目的一等公民，必须满足：

* 可配置采样频率、噪声、范围、模式
* 支持固定随机种子
* 使用统一时间源
* 生命周期行为明确（start / pause / dispose）

任何重构不得破坏：

* 可复现性
* 与真实 service 的可替换性
* provider 对数据的假设

---

## 6. 日志与变更记录（强制）

### 6.1 日志位置

**每一次代码更新都必须追加记录到：**

```text
docs/agent_logs.md
```

不得覆盖、不得删除历史记录。

---

### 6.2 日志语言

* **必须使用中文**
* 表达清晰、具体、可追溯
* 避免只写“重构”“优化”等模糊描述

---

### 6.3 日志内容（至少包含）

每次记录至少包含以下部分：

* 修改了哪些模块 / 文件
* 做出了什么修改
* 属于重构、修复还是结构调整

---

## 7. 常见问题与约定补充

### 7.1 Riverpod 3 相关

* Riverpod 3 已移除 `valueOrNull`
* 统一使用：

```dart
asyncValue.asData?.value
```

* 禁止使用 `.value!` 绕过状态判断

---

### 7.2 ValueListenable 相关

在使用：

* `ValueListenable`
* `ValueListenableBuilder`

时，**必须显式引入**：

```dart
import 'package:flutter/foundation.dart';
```

避免因隐式依赖导致类型无法识别或行为不一致。

---

## 8. Agent 自检要求

在提交任何代码前，Agent 必须自问并确认：

* 功能是否与重构前一致？
* 测试是否能捕获潜在回退？
* provider 是否仍是唯一业务真相？
* Fake 与真实实现是否仍然等价？
* 变更是否已完整记录在日志中？

若任一问题无法肯定回答，必须先修正。
